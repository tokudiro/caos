--- TestBuf.expect.c	2016-04-20 22:42:04.114592700 +0900
+++ TestBuf.c	2016-05-03 23:15:27.315198100 +0900
@@ -1,3 +1,4 @@
+#include <stdio.h>
 #include <string.h>
 
 #include "boolean.h"
@@ -5,45 +6,110 @@
 #include "common.h"
 
 #include "TestBuf_define.h"
-//Class:TestBuf
+#include "TestBuf_private.h"
+/* class TestBuffer */
+static struct TestBuffer_struct instance;
+TestBuffer TestBuffer_getInstance() { return &instance; }
+#line 8 "TestBuf.caos"
+
 
 /**
  * initial
  */
-void TestBuf_init(TestBuf* this){
-	this->first = 0;
-	this->last = 0;
-}
-
-void TestBuf_enque(TestBuf* this, char* str, int len, buftype type){
-	memset(this->buf[this->last], 0, MAX_BUF);
-	strncpy( &(this->buf[this->last][0]), str, len);
-	this->type[this->last] = type;
-	this->last++;
-	if (this->last==MAX_TMP) {this->last=0;}
-}
-
-char* TestBuf_deque(TestBuf* this, buftype* p_type){
-	char* ret = this->buf[this->first];
-	*p_type = this->type[this->first];
-	this->first++;
-	if (this->first==MAX_TMP) {this->first=0;}
+#line 17 "TestBuf.caos"
+void TestBuffer_init(TestBuffer self){
+	self->first = 0;
+	self->last = 0;
+}
+
+// enque
+#line 23 "TestBuf.caos"
+void TestBuffer_enque(TestBuffer self, char* str, int len, buftype type){
+	memset(&(self->buf[self->last][0]), 0, MAX_BUF);
+	strcpy( &(self->buf[self->last][0]), str);
+	self->type[self->last] = type;
+	self->last++;
+	if (self->first == self->last) {/* buffer over */;}
+	if (self->last==MAX_TMP) {self->last=0;}
+}
+
+#line 32 "TestBuf.caos"
+char* TestBuffer_deque(TestBuffer self, buftype* p_type) {
+	char* ret = self->buf[self->first];
+	*p_type = self->type[self->first];
+	self->first++;
+	if (self->first==MAX_TMP) {self->first=0;}
 	return ret;
 }
 
-boolean TestBuf_empty(TestBuf* this) {
-	return (this->first==this->last?TRUE:FALSE);
+#line 40 "TestBuf.caos"
+boolean TestBuffer_empty(TestBuffer self){
+	return (self->first==self->last?TRUE:FALSE);
 }
 
-char* TestBuf_allque(TestBuf* this, char* buf){
+#line 44 "TestBuf.caos"
+char* TestBuffer_allque(TestBuffer self, char* buf, char* class_buf_str) {
 	buftype type;
 	char* str;
-	while(TestBuf_empty(this) == FALSE) {
-		str = TestBuf_deque(this, &type);
-		if (type == OBJECT) {
-			printf("obj_%s",  str);
-		} else {
-			printf("%s",  str);
+	buf[0] = 0;
+	while(TestBuffer_empty(self) == FALSE) {
+		str = TestBuffer_deque(self, &type);
+		switch(type) {
+		case T_OBJECT:
+			strcat(buf, "this->");
+			break;
+		case T_METHOD:
+			strcat(buf, class_buf_str);
+			strcat(buf, "_");
+			break;
+		}
+		strcat(buf,  str);
+	}
+	return buf;
+}
+
+#line 64 "TestBuf.caos"
+boolean TestBuffer_back_retype(TestBuffer self, buftype find, buftype replace) {
+	if (TestBuffer_empty(self) ) return FALSE;
+	
+	// ƒRƒƒ“ƒg
+	int index = self->last;
+	while( index != self->first) {
+		index--;
+		if ( index < 0 ) index=MAX_TMP;
+		if ( self->type[index] == T_DOT ) { return FALSE; }
+		if ( self->type[index] == find ) {
+			self->type[index] = replace;
+			return TRUE;
+		}
+	}
+	return FALSE;
 		}
+
+#line 81 "TestBuf.caos"
+int TestBuffer_public(TestBuffer self) {
+	return TestBuffer_private(self);
+}
+
+#line 85 "TestBuf.caos"
+int TestBuffer_private(TestBuffer self) {
+	return 1;
+}
+
+int other_function(int x)
+{
+	return 0;
 	}
+
+
+
+int main(void)
+{
+	struct TestBuffer_struct buf;
+	char longbuf[100] = {0};
+	TestBuffer_init(&buf);
+	TestBuffer_enque(&buf, "aaa", 3, T_WORD);
+	TestBuffer_enque(&buf, "bb", 2, T_WORD);
+	printf("%s\n", TestBuffer_allque(&buf, longbuf, "zzz") );
+	return 0;
 }
--- TestBuf.expect.h	2016-04-20 22:42:25.651025800 +0900
+++ TestBuf.h	2016-05-03 23:15:27.315198100 +0900
@@ -1,11 +1,21 @@
-#ifndef __TestBuf__
-#define __TestBuf__
-//Class:TestBuf
-typedef struct TestBuf_Struct TestBuf;
-void TestBuf_init(TestBuf this);
-void TestBuf_enque(TestBuf this, char* str, int len, buftype type);
-char* TestBuf_deque(TestBuf this, buftype* p_type) ;
-boolean TestBuf_empty(TestBuf this);
-char* TestBuf_allque(TestBuf this, char* buf, char* class_buf_str);
-boolean TestBuf_back_retype(TestBuf this, buftype find, buftype replace);
-#endif
+#ifndef __TestBuf_H__
+#define __TestBuf_H__
+/* class TestBuffer */
+#line 8 "TestBuf.caos"
+typedef struct TestBuffer_struct* TestBuffer;
+TestBuffer TestBuffer_getInstance();
+#line 17 "TestBuf.caos"
+void TestBuffer_init(TestBuffer self);
+#line 23 "TestBuf.caos"
+void TestBuffer_enque(TestBuffer self, char* str, int len, buftype type);
+#line 32 "TestBuf.caos"
+char* TestBuffer_deque(TestBuffer self, buftype* p_type) ;
+#line 40 "TestBuf.caos"
+boolean TestBuffer_empty(TestBuffer self);
+#line 44 "TestBuf.caos"
+char* TestBuffer_allque(TestBuffer self, char* buf, char* class_buf_str) ;
+#line 64 "TestBuf.caos"
+boolean TestBuffer_back_retype(TestBuffer self, buftype find, buftype replace) ;
+#line 81 "TestBuf.caos"
+int TestBuffer_public(TestBuffer self) ;
+#endif /* __TestBuf_H__ */
--- A.expect.c	2016-02-03 23:10:48.994051300 +0900
+++ A.c	2016-05-03 23:15:27.353031800 +0900
@@ -1,13 +1,27 @@
 #include  "B.h"
 
+
 /* ã‚¯ãƒ©ã‚¹A */
-#include "A_def.h"
-//Class:A
+#include "A_define.h"
+#include "A_private.h"
+/* class A */
+
 
 
-int A_func(A* this, C* c) {
-  B* b;
+int func(C* c) {
+  B b;
   B_func(b, c);
+  printf("@x \"");
   return 0;
 }
 
+#define X(a) %a_X()
+
+int A_function(A* this, int x1, int x2){
+	return x1+x2;
+}
+  #+void unfuction(void){}
+
+#define PRINT(import) printf("#import\n")
+
+
